# /etc/chrony/chrony.conf - Optimized GPS Chrony Configuration for RPI Clock
# GPS-synchronized time server for local Raspberry Pi clock

# Essential files
driftfile /var/lib/chrony/drift

# Logging - Reduced for performance (removed 'statistics' to reduce I/O overhead)
logdir /var/log/chrony
log measurements tracking

# Security - Local access only (no public time serving needed for local clock)
cmdport 127.0.0.1
cmdallow 127.0.0.1
cmdallow ::1
cmddeny 0.0.0.0/0
cmddeny ::/0

# GPS Reference Clock - Primary time source
# Using SHM 4 for GPS data (confirmed via ntpshmmon)
# offset -0.440 delay 0.1 - corrected for GPS timing offset (440ms)
refclock SHM 4 offset -0.440 delay 0.1 refid GPS poll 4
refclock PPS /dev/pps0 lock GPS refid PPS poll 4 prefer

# Fallback servers - Only when GPS is unavailable
# ntp.se - Swedish University Computer Network (academic, reliable)
# pool.ntp.org - Community pool (redundant, distributed)
server ntp.se iburst minpoll 6 maxpoll 10
server pool.ntp.org iburst minpoll 6 maxpoll 10


# Performance tuning - Optimized for Raspberry Pi
# maxupdateskew 50.0 - Reduced from 100.0 for ARM efficiency
maxupdateskew 50.0
maxdrift 500.0
maxchange 2000 1 2
maxchange 4000 1 2
maxchange 8000 1 2

# GPS-specific optimizations
# minsamples 3 - Require more samples for GPS stability
# maxsamples 8 - Allow more samples for better GPS accuracy
# minsources 1 - Allow GPS-only operation when available
minsamples 3
maxsamples 8
minsources 1

# Local stratum for time serving
local stratum 10

# Additional GPS optimizations
# makestep 0.1 3 - Allow small time steps for GPS precision
# corrtimeratio 0.001 - Fine-tune GPS timing corrections
# maxchange 1000 1 2 - Limit large time changes for GPS stability
makestep 0.1 3
corrtimeratio 0.001
maxchange 1000 1 2
